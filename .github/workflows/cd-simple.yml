name: Continuous Deployment
on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ${ env.IMAGE_TAG_BACKEND }
  FRONTEND_IMAGE: ${ env.IMAGE_TAG_FRONTEND }
  DEPLOY_PATH: ~/deployments/rust-actix-web_cd

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT_OR_TOKEN }}

      - name: Generate image tags
        id: tags
        run: |
          # Generate a version tag using timestamp and short SHA
          VERSION="$(date +%Y%m%d)-$(echo ${{ github.sha }} | cut -c1-7)"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BACKEND_TAG=${{ env.BACKEND_IMAGE }}:$VERSION" >> $GITHUB_OUTPUT
          echo "FRONTEND_TAG=${{ env.FRONTEND_IMAGE }}:$VERSION" >> $GITHUB_OUTPUT

      - name: Build and push backend image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:latest
            ${{ steps.tags.outputs.BACKEND_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ steps.tags.outputs.VERSION }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:latest
            ${{ steps.tags.outputs.FRONTEND_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ steps.tags.outputs.VERSION }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    concurrency:
      group: production_environment
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Create .env file from secret
        run: |
          echo "${{ secrets.PROD_ENV_FILE }}" > .env

      - name: Create deployment directory on server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p ${{ env.DEPLOY_PATH }}"

      - name: Transfer files to server
        run: |
          scp -o StrictHostKeyChecking=no \
            docker-compose.yml \
            .env \
            nginx.conf \
            ./deployment/scripts/deploy.sh \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << EOF
            cd ${{ env.DEPLOY_PATH }}
            chmod +x deploy.sh
            
            # Set environment variables for deployment
            export IMAGE_TAG_BACKEND="${{ env.BACKEND_IMAGE }}:latest"
            export IMAGE_TAG_FRONTEND="${{ env.FRONTEND_IMAGE }}:latest"
            
            # Login to GitHub Container Registry on server
            echo "${{ secrets.GHCR_PAT_OR_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
            
            # Run the deployment script
            ./deploy.sh
            
            # Logout from registry
            docker logout ${{ env.REGISTRY }}
          EOF

      - name: Verify deployment
        run: |
          # Give services a moment to fully initialize
          sleep 5

          MAX_ATTEMPTS=5
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Verification attempt $ATTEMPT of $MAX_ATTEMPTS..."
            if ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "curl -s -f http://localhost:90/ > /dev/null"; then
              echo "✅ Deployment verified successfully!"
              exit 0
            fi
            
            ATTEMPT=$((ATTEMPT+1))
            [ $ATTEMPT -le $MAX_ATTEMPTS ] && sleep 3
          done

          echo "❌ Failed to verify deployment after $MAX_ATTEMPTS attempts"
          exit 1
